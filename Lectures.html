<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مكتبة الكتب الصوتية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="container">
    <img src="VoiceBook.png" alt="VoiceBook Logo" class="logo">
    <h1 id="bookTitle">مكتبة الكتب الصوتية</h1>
    <h2 id="bookName">تحميل الكتاب...</h2>
    <h3 id="bookSheikh"></h3>
    <p>اختر رقم المحاضرة للاستماع</p>

    <div class="grid" id="lecturesGrid"></div>
  </div>

  <div class="player-card" id="playerCard" style="display:none;">
    <button class="close-btn" onclick="closePlayer()">×</button>
    <div class="player-time-row">
      <span id="currentTimeLabel">00:00:00</span>
      <div class="play-circle" id="playBtn">▶
        <svg class="progress-ring" width="120" height="120">
          <circle class="progress-ring__circle" stroke="#ffd166" stroke-width="6" fill="transparent" r="54" cx="60" cy="60"/>
        </svg>
      </div>
      <span id="durationLabel">00:00:00</span>
    </div>
    <div class="time-controls">
      <button onclick="decreaseTime()">➖</button>
      <span id="timeValue">0</span>
      <button onclick="increaseTime()">➕</button>
    </div>
    <audio id="audio" preload="metadata"></audio>
  </div>

<script>
const lecturesGrid = document.getElementById('lecturesGrid');
const playerCard = document.getElementById('playerCard');
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
const currentTimeLabel = document.getElementById('currentTimeLabel');
const durationLabel = document.getElementById('durationLabel');
const timeValueEl = document.getElementById('timeValue');

let currentMinutes = 0;
let maxMinutes = 0;

const params = new URLSearchParams(window.location.search);
const bookID = params.get("book");

const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTi8zqn1us53rSDKQXYudQWh5BHNpDVJAeAK30UFhP48_MBwrXlHKoM9yevR-TUe843ZPBIVJHV_Y2m/pub?gid=0&single=true&output=csv";

function extractFolderAndPattern(fullUrl){
  const folder = fullUrl.substring(0, fullUrl.lastIndexOf('/') + 1);
  const file   = decodeURIComponent(fullUrl.split('/').pop());
  const match  = file.match(/^(.*?)(\d+)\.(mp3)$/i);
  if(!match) return null;
  return {
    folder,
    prefix: match[1],
    digits: match[2].length,
    ext: match[3]
  };
}

fetch(sheetUrl)
  .then(res => res.text())
  .then(csv => {
    const lines = csv.trim().split("\n");
    const headers = lines[0].replace(/\uFEFF/g,"").split(",").map(h => h.trim());
    const rows = lines.slice(1);

    const colIndex = {
      ID: headers.indexOf("ID"),
      book: headers.indexOf("book"),
      sheikh: headers.indexOf("sheikh"),
      count: headers.indexOf("count"),
      folderUrl: headers.indexOf("folderUrl")
    };

    const book = rows.map(line => line.split(","))
                     .find(cols => cols[colIndex.ID] === bookID);

    if(!book){
      lecturesGrid.innerHTML = "<p>الكتاب غير موجود</p>";
      return;
    }

    const bookName = book[colIndex.book];
    const bookSheikh = book[colIndex.sheikh];
    const lecturesCount = parseInt(book[colIndex.count]);
    const inputUrl = book[colIndex.folderUrl];

    const info = extractFolderAndPattern(inputUrl);
    if(!info){
      lecturesGrid.innerHTML = "<p>رابط الملف غير صالح</p>";
      return;
    }

    document.getElementById("bookName").textContent = bookName;
    document.getElementById("bookSheikh").textContent = `للشيخ ${bookSheikh}`;

    for(let i=1; i<=lecturesCount; i++){
      const num = info.digits === 2 ? String(i).padStart(2,'0') : String(i);
      const audioSrc = `${info.folder}${info.prefix}${num}.${info.ext}`;

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = `المحاضرة ${i}`;
      btn.onclick = () => openPlayer(i, audioSrc, btn);
      lecturesGrid.appendChild(btn);
    }
  });

function openPlayer(title, src, btn){
  stopAudio();
  audio.src = src;
  playerCard.style.display = "block";
  btn.after(playerCard);
  audio.load();
  audio.pause();
  playBtn.textContent = "▶";
  currentMinutes = 0;
  timeValueEl.textContent = currentMinutes;
}

function closePlayer(){ audio.pause(); playerCard.style.display = "none"; }

const progressCircle = document.querySelector('.progress-ring__circle');
const radius = progressCircle.r.baseVal.value;
const circumference = 2 * Math.PI * radius;
progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
progressCircle.style.strokeDashoffset = circumference;

function setProgress(percent){
  const offset = circumference - (percent/100)*circumference;
  progressCircle.style.strokeDashoffset = offset;
}

playBtn.addEventListener("click", ()=>{
  if(audio.paused){ audio.play(); playBtn.textContent='⏸'; }
  else { audio.pause(); playBtn.textContent='▶'; }
});

audio.addEventListener("timeupdate", ()=>{
  const percent = (audio.currentTime/audio.duration)*100;
  setProgress(percent);
  currentTimeLabel.textContent = formatTime(audio.currentTime);
});

audio.addEventListener("loadedmetadata", ()=>{
  maxMinutes = Math.floor(audio.duration/60);
  if(maxMinutes<1) maxMinutes=1;
  durationLabel.textContent = formatTime(audio.duration);
});

function increaseTime(){ if(audio.paused && currentMinutes<maxMinutes){ currentMinutes++; updateMinuteLabel(); } }
function decreaseTime(){ if(audio.paused && currentMinutes>0){ currentMinutes--; updateMinuteLabel(); } }
function updateMinuteLabel(){ timeValueEl.textContent = currentMinutes; audio.currentTime = currentMinutes*60; }

function formatTime(totalSeconds){
  const h = Math.floor(totalSeconds/3600);
  const m = Math.floor((totalSeconds%3600)/60);
  const s = Math.floor(totalSeconds%60);
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function stopAudio(){ audio.pause(); playBtn.textContent='▶'; }
</script>

</body>
</html>
